# Trellis Master Configuration

The **Trellis System** is a procedural modification layer that runs on top of the standard seed growth steps. Trellises are effectively "decorators" or "middleware" that can intercept seed lifecycle events—like ejection, growth, or corridor assembly—to enforce specific constraints, modify properties, or alter behavior.

Trellises are assigned to seeds via the `trellis` array in the `ManualSeedConfig` (e.g., `trellis: ['#spawn(4, 2)', '#cell']`).

---

## Available Trellises

### 1. Spawn Trellis (`#spawn`)
**Phase:** `ejection`

**Description:**
Handles "Burst Ejection." It allows a single logical seed configuration to expand into multiple physical seeds (a "cluster"). All seeds in the cluster originate from the same spine tile but are pushed progressively further away from the spine (increasing their `distance`).

- **Cluster ID:** All seeds generated by a single `#spawn` call share a unique `clusterId`. This links them together for other logic (like the `#cell` trellis shared wall detection).
- **Limit Counting:** Every physical seed created counts toward the global `seedCount` limit. A `#spawn(4)` call will consume 4 slots from the total limit.
- **ID Generation:** Seeds in a cluster are assigned sequential IDs based on their Pouch Index and a letter suffix. The Master Seed gets 'a', replicas get 'b', 'c', etc. (e.g., `4a_L`, `4b_L`).

**Usage:**
`#spawn(count, distanceIncrement)`

**Arguments:**
| Argument | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `count` | `number` \| `Range` | `1` | The total number of seeds to generate in this cluster (including the original). |
| `distanceIncrement` | `number` \| `Range` | `0` | The additional distance added to each subsequent seed in the cluster. |

**Example:**
```json
{
  "type": "cell",
  "trellis": ["#spawn(4, 2)"],
  "distance": 3
}
```
*Result:* Generates 4 seeds.
- Seed 1: Distance 3
- Seed 2: Distance 5 (3 + 2)
- Seed 3: Distance 7 (3 + 4)
- Seed 4: Distance 9 (3 + 6)

---

### 2. Cell Trellis (`#cell`)
**Phases:** `classification`, `corridorAssembly`

**Description:**
Enforces layout rules for "Cell Block" style rooms—typically small, uniform, repeating units (like prison cells, barracks, or crypts).

**Key Behaviors:**
1.  **Shared Wall Blocking:** Detects if the cell has adjacent sibling cells (checking +/- 2 tiles from center). If a neighbor is found, the shared wall is marked as **IMPASSABLE** (Heat Score 500) to prevents doors from forming between cells.
2.  **Single Exit Enforcement:**
    - Guaranteed **One Way In/Out**.
    - If the cell touches an existing corridor/spine, it locks onto that connection immediately.
    - Blocking: Once an exit is determined, it blocks all opposing walls.
    - Anti-Wrapping: During path generation, the cell's perimeter is strictly blocked to prevent the corridor from wrapping around and creating a second opening.

**Usage:**
`#cell`

**Arguments:**
*None*

---

### 3. Tiny Titan Trellis (`#tinytitan`)
**Phases:** `ejection`, `classification`

**Description:**
Creates "Minimum Viable Rooms." It overrides the seed's target dimensions to force a **1x1** size and applies an **immunity flag** (`immuneToPruning`).

**Use Case:**
Perfect for essential 1-tile markers that must exist but shouldn't grow large, such as:
- Stairs / Elevators
- Quest items / Altars
- Checkpoints
- Trap triggers

**Key Behaviors:**
- **Forces Size:** Overrides `targetWidth` and `targetHeight` to 1.
- **Pruning Immunity:** Sets `immuneToPruning: true` in metadata, preventing the generator's cleanup phase from removing it even if it has no connections or small size.

**Usage:**
`#tinytitan`

**Arguments:**
*None*

---

## Trellis Phases

Trellises can hook into specific moments in the generation pipeline:

1.  **`ejection`**: When a seed is first pulled from the pouch and placed on the spine. Good for modifying initial properties (distance, size) or creating clones (like `#spawn`).
2.  **`growth`**: (Not currently used by standard set) During the cellular automata expansion.
3.  **`classification`**: After growth finishes. Good for tagging metadata or applying immunity flags.
4.  **`corridorAssembly`**: Before/During pathfinding. Good for modifying the Heat Map to block walls or guide connections.
